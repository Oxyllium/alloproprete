<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin | Oxyllium Leads</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f1f5f9; color: #1e293b; min-height: 100vh; }

        /* Header */
        .header { background: #1a365d; color: #fff; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header h1 span { color: #10b981; }
        .header__logout { background: rgba(255,255,255,0.15); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .header__logout:hover { background: rgba(255,255,255,0.25); }

        /* Tabs */
        .tabs { display: flex; gap: 0; background: #fff; border-bottom: 2px solid #e2e8f0; padding: 0 24px; }
        .tab { padding: 14px 24px; font-size: 14px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
        .tab:hover { color: #1a365d; }
        .tab--active { color: #059669; border-bottom-color: #059669; }

        /* Content */
        .content { max-width: 1200px; margin: 0 auto; padding: 24px; }

        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; }
        .stat__number { font-size: 28px; font-weight: 700; color: #1a365d; }
        .stat__label { font-size: 13px; color: #64748b; margin-top: 4px; }
        .stat--nouveau .stat__number { color: #f59e0b; }
        .stat--approuve .stat__number { color: #059669; }
        .stat--rejete .stat__number { color: #dc2626; }

        /* Table */
        .table-wrap { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .table-header { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .table-header h2 { font-size: 16px; font-weight: 600; }
        .filter-group { display: flex; gap: 8px; }
        .filter-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid #e2e8f0; background: #fff; font-size: 13px; cursor: pointer; color: #64748b; }
        .filter-btn:hover, .filter-btn--active { background: #1a365d; color: #fff; border-color: #1a365d; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        td { padding: 14px 16px; font-size: 14px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        tr:hover td { background: #f8fafc; }

        /* Badges */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge--nouveau { background: #fef3c7; color: #92400e; }
        .badge--approuve { background: #d1fae5; color: #065f46; }
        .badge--rejete { background: #fee2e2; color: #991b1b; }
        .badge--devis { background: #dbeafe; color: #1e40af; }
        .badge--contact { background: #f3e8ff; color: #6b21a8; }

        /* Actions */
        .actions { display: flex; gap: 6px; }
        .btn-action { padding: 6px 14px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .btn-approve { background: #059669; color: #fff; }
        .btn-approve:hover { background: #047857; }
        .btn-reject { background: #fff; color: #dc2626; border: 1px solid #fecaca; }
        .btn-reject:hover { background: #fef2f2; }
        .btn-detail { background: #f1f5f9; color: #475569; }
        .btn-detail:hover { background: #e2e8f0; }

        /* Config */
        .config-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 24px; max-width: 600px; }
        .config-card + .config-card { margin-top: 16px; }
        .config-card h2 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .config-card p { font-size: 14px; color: #64748b; margin-bottom: 16px; }
        .config-card textarea { width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; }
        .config-card textarea:focus { outline: none; border-color: #059669; }
        .btn-save { margin-top: 12px; background: #059669; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-save:hover { background: #047857; }

        /* Loading & empty */
        .loading { text-align: center; padding: 48px; color: #94a3b8; }
        .loading::after { content: ''; display: block; width: 32px; height: 32px; margin: 16px auto; border: 3px solid #e2e8f0; border-top-color: #059669; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 48px; color: #94a3b8; font-size: 15px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: #fff; border-radius: 16px; max-width: 560px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 24px; }
        .modal h3 { font-size: 18px; margin-bottom: 16px; }
        .modal-row { display: flex; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .modal-row:last-child { border-bottom: none; }
        .modal-label { width: 120px; font-weight: 600; color: #64748b; font-size: 14px; flex-shrink: 0; }
        .modal-value { font-size: 14px; color: #1e293b; }
        .modal-close { margin-top: 16px; width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; font-size: 14px; cursor: pointer; }

        /* Approve modal */
        .approve-form { margin-top: 16px; }
        .approve-form label { display: block; font-weight: 600; font-size: 14px; color: #475569; margin-bottom: 8px; }
        .approve-form select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; background: #fff; cursor: pointer; }
        .approve-form select:focus { outline: none; border-color: #059669; }
        .approve-price { margin-top: 12px; padding: 16px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; }
        .approve-price__row { display: flex; justify-content: space-between; font-size: 14px; padding: 4px 0; }
        .approve-price__row--total { font-weight: 700; font-size: 16px; color: #059669; border-top: 1px solid #bbf7d0; padding-top: 8px; margin-top: 4px; }
        .approve-actions { display: flex; gap: 10px; margin-top: 16px; }
        .approve-actions button { flex: 1; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-confirm-approve { background: #059669; color: #fff; border: none; }
        .btn-confirm-approve:hover { background: #047857; }
        .btn-cancel { background: #fff; color: #64748b; border: 1px solid #e2e8f0; }

        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; background: #1a365d; color: #fff; padding: 14px 20px; border-radius: 10px; font-size: 14px; z-index: 200; opacity: 0; transform: translateY(10px); transition: all 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast--success { background: #059669; }
        .toast--error { background: #dc2626; }

        /* ROI Dashboard */
        .roi-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .roi-stat { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; }
        .roi-stat__number { font-size: 28px; font-weight: 700; }
        .roi-stat__label { font-size: 13px; color: #64748b; margin-top: 4px; }
        .roi-stat--spend .roi-stat__number { color: #dc2626; }
        .roi-stat--revenue .roi-stat__number { color: #059669; }
        .roi-stat--roi .roi-stat__number { color: #1a365d; }
        .roi-stat--cpl .roi-stat__number { color: #7c3aed; }

        .roi-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .roi-toolbar h2 { font-size: 18px; font-weight: 600; }
        .period-group { display: flex; gap: 6px; }
        .period-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid #e2e8f0; background: #fff; font-size: 13px; cursor: pointer; color: #64748b; }
        .period-btn:hover, .period-btn--active { background: #1a365d; color: #fff; border-color: #1a365d; }

        .roi-table-wrap { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .roi-bar-cell { display: flex; align-items: center; gap: 8px; }
        .roi-bar { height: 8px; border-radius: 4px; min-width: 2px; }
        .roi-bar--spend { background: #fca5a5; }
        .roi-bar--revenue { background: #6ee7b7; }
        .roi-positive { color: #059669; font-weight: 600; }
        .roi-negative { color: #dc2626; font-weight: 600; }

        .budget-form { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 24px; }
        .budget-form h3 { font-size: 15px; font-weight: 600; margin-bottom: 12px; }
        .budget-form__row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .budget-form__field { display: flex; flex-direction: column; gap: 4px; }
        .budget-form__field label { font-size: 12px; font-weight: 600; color: #64748b; }
        .budget-form__field input { padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; }
        .budget-form__field input:focus { outline: none; border-color: #059669; }
        .btn-add-budget { padding: 10px 20px; background: #1a365d; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .btn-add-budget:hover { background: #2d4a7c; }
        .btn-delete-budget { background: none; border: none; color: #dc2626; cursor: pointer; font-size: 13px; padding: 4px 8px; border-radius: 6px; }
        .btn-delete-budget:hover { background: #fef2f2; }

        /* Responsive */
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .roi-stats { grid-template-columns: repeat(2, 1fr); }
            .table-wrap { overflow-x: auto; }
            .roi-table-wrap { overflow-x: auto; }
            table { min-width: 700px; }
            .filter-group { flex-wrap: wrap; }
            .period-group { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Oxyllium <span>Leads</span></h1>
        <button class="header__logout" onclick="location.reload()">Déconnexion</button>
    </div>

    <div class="tabs">
        <div class="tab tab--active" data-tab="leads" onclick="switchTab('leads')">Leads</div>
        <div class="tab" data-tab="roi" onclick="switchTab('roi')">ROI</div>
        <div class="tab" data-tab="config" onclick="switchTab('config')">Paramètres</div>
    </div>

    <div class="content">
        <!-- LEADS TAB -->
        <div id="tab-leads">
            <div class="stats" id="stats"></div>
            <div class="table-wrap">
                <div class="table-header">
                    <h2>Tous les leads</h2>
                    <div class="filter-group">
                        <button class="filter-btn filter-btn--active" onclick="filterLeads('all', this)">Tous</button>
                        <button class="filter-btn" onclick="filterLeads('nouveau', this)">Nouveaux</button>
                        <button class="filter-btn" onclick="filterLeads('approuvé', this)">Approuvés</button>
                        <button class="filter-btn" onclick="filterLeads('rejeté', this)">Rejetés</button>
                        <button class="filter-btn" onclick="exportConversionsCSV()" title="Exporter les conversions pour Microsoft Ads" style="background:#1a365d;color:#fff;border-color:#1a365d;">Exporter CSV</button>
                    </div>
                </div>
                <div id="leads-body">
                    <div class="loading">Chargement des leads...</div>
                </div>
            </div>
        </div>

        <!-- ROI TAB -->
        <div id="tab-roi" style="display: none;">
            <div class="roi-stats" id="roi-stats">
                <div class="roi-stat roi-stat--spend"><div class="roi-stat__number" id="roi-total-spend">—</div><div class="roi-stat__label">Dépenses pub HT</div></div>
                <div class="roi-stat roi-stat--revenue"><div class="roi-stat__number" id="roi-total-revenue">—</div><div class="roi-stat__label">Revenus leads HT</div></div>
                <div class="roi-stat roi-stat--roi"><div class="roi-stat__number" id="roi-total-roi">—</div><div class="roi-stat__label">ROI</div></div>
                <div class="roi-stat roi-stat--cpl"><div class="roi-stat__number" id="roi-total-cpl">—</div><div class="roi-stat__label">Coût par lead HT</div></div>
            </div>
            <div class="budget-form">
                <h3>Ajouter une dépense</h3>
                <div class="budget-form__row">
                    <div class="budget-form__field">
                        <label>Mois</label>
                        <input type="month" id="budget-month" value="">
                    </div>
                    <div class="budget-form__field">
                        <label>Montant HT (€)</label>
                        <input type="number" id="budget-amount" placeholder="0.00" step="0.01" min="0" style="width:120px;">
                    </div>
                    <div class="budget-form__field">
                        <label>Source</label>
                        <input type="text" id="budget-source" value="Microsoft Ads" style="width:160px;">
                    </div>
                    <button class="btn-add-budget" onclick="addBudget()">Ajouter</button>
                </div>
            </div>
            <div class="roi-toolbar">
                <h2>Détail mensuel</h2>
                <div class="period-group">
                    <button class="period-btn" onclick="setROIPeriod(3, this)">3 mois</button>
                    <button class="period-btn period-btn--active" onclick="setROIPeriod(6, this)">6 mois</button>
                    <button class="period-btn" onclick="setROIPeriod(12, this)">12 mois</button>
                </div>
            </div>
            <div class="roi-table-wrap">
                <div id="roi-table-body">
                    <div class="loading">Chargement des données...</div>
                </div>
            </div>
        </div>

        <!-- CONFIG TAB -->
        <div id="tab-config" style="display: none;">
            <div class="config-card">
                <h2>Emails clients destinataires</h2>
                <p>Entrez les adresses email qui recevront les leads approuvés, une par ligne.</p>
                <textarea id="client-emails" placeholder="client1@example.com&#10;client2@example.com"></textarea>
                <button class="btn-save" onclick="saveConfig()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal" id="modal-content"></div>
    </div>

    <!-- Approve Modal -->
    <div class="modal-overlay" id="approve-modal">
        <div class="modal" id="approve-modal-content"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    const API = '/.netlify/functions/leads';
    let password = '';
    let allLeads = [];
    let currentFilter = 'all';

    const prestationLabels = {
        'fin-chantier': 'Fin de chantier',
        'etat-lieux': 'État des lieux',
        'bureaux': 'Bureaux',
        'copropriete': 'Copropriété',
        'locaux-commerciaux': 'Locaux commerciaux',
        'industriel': 'Industriel',
        'vitres': 'Vitres',
        'remise-etat': 'Remise en état',
        'autre': 'Autre'
    };

    const leadTypes = [
        { id: 'ponctuel', label: 'Nettoyage ponctuel / Demande de devis simple', ht: 30, ttc: 36 },
        { id: 'general', label: 'Nettoyage général / Entretien régulier', ht: 50, ttc: 60 },
        { id: 'fin-chantier', label: 'Nettoyage de fin de chantier', ht: 70, ttc: 84 },
        { id: 'contrat', label: 'Contrat annuel / Marché récurrent', ht: 90, ttc: 108 }
    ];

    // ── Auth ──
    async function init() {
        password = prompt('Mot de passe admin :');
        if (!password) {
            document.querySelector('.content').innerHTML = '<div class="empty">Accès refusé.</div>';
            return;
        }
        await loadLeads();
        await loadConfig();
    }

    async function apiCall(action, method, body) {
        const opts = {
            method: method || 'GET',
            headers: { 'Authorization': 'Bearer ' + password }
        };
        if (body) {
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify(body);
        }
        const res = await fetch(API + '?action=' + action, opts);
        if (res.status === 401) {
            toast('Mot de passe incorrect', 'error');
            throw new Error('401');
        }
        return res.json();
    }

    // ── Tabs ──
    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab--active'));
        document.querySelector(`[data-tab="${tab}"]`).classList.add('tab--active');
        document.getElementById('tab-leads').style.display = tab === 'leads' ? 'block' : 'none';
        document.getElementById('tab-roi').style.display = tab === 'roi' ? 'block' : 'none';
        document.getElementById('tab-config').style.display = tab === 'config' ? 'block' : 'none';
        if (tab === 'config') loadConfig();
        if (tab === 'roi') loadROIData();
    }

    // ── Leads ──
    async function loadLeads() {
        document.getElementById('leads-body').innerHTML = '<div class="loading">Chargement des leads...</div>';
        try {
            const data = await apiCall('list');
            allLeads = data.leads || [];
            renderStats();
            renderLeads();
        } catch (e) {
            document.getElementById('leads-body').innerHTML = '<div class="empty">Erreur de chargement.</div>';
        }
    }

    function renderStats() {
        const total = allLeads.length;
        const nouveau = allLeads.filter(l => l.status === 'nouveau').length;
        const approuve = allLeads.filter(l => l.status === 'approuvé').length;
        const rejete = allLeads.filter(l => l.status === 'rejeté').length;

        document.getElementById('stats').innerHTML = `
            <div class="stat"><div class="stat__number">${total}</div><div class="stat__label">Total</div></div>
            <div class="stat stat--nouveau"><div class="stat__number">${nouveau}</div><div class="stat__label">Nouveaux</div></div>
            <div class="stat stat--approuve"><div class="stat__number">${approuve}</div><div class="stat__label">Approuvés</div></div>
            <div class="stat stat--rejete"><div class="stat__number">${rejete}</div><div class="stat__label">Rejetés</div></div>
        `;
    }

    function renderLeads() {
        const filtered = currentFilter === 'all' ? allLeads : allLeads.filter(l => l.status === currentFilter);

        if (filtered.length === 0) {
            document.getElementById('leads-body').innerHTML = '<div class="empty">Aucun lead trouvé.</div>';
            return;
        }

        let html = `<table>
            <thead><tr>
                <th>Date</th><th>Type</th><th>Nom</th><th>Contact</th><th>Ville</th><th>Prestation</th><th>Statut</th><th>Actions</th>
            </tr></thead><tbody>`;

        filtered.forEach(lead => {
            const date = lead.timestamp ? new Date(lead.timestamp).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' }) : '—';
            const formBadge = `<span class="badge badge--${lead.form_name || 'devis'}">${lead.form_name || 'devis'}</span>`;
            const statusBadge = `<span class="badge badge--${lead.status || 'nouveau'}">${lead.status || 'nouveau'}</span>`;
            const presta = prestationLabels[lead.prestation] || lead.prestation || '—';

            let actions = `<button class="btn-action btn-detail" onclick='showDetail(${JSON.stringify(lead).replace(/'/g, "&#39;")})'>Détail</button>`;
            if (lead.status === 'nouveau') {
                actions += `<button class="btn-action btn-approve" onclick="showApproveModal(${lead._row})">Valider</button>`;
                actions += `<button class="btn-action btn-reject" onclick="rejectLead(${lead._row})">Rejeter</button>`;
            }

            html += `<tr>
                <td>${date}</td>
                <td>${formBadge}</td>
                <td><strong>${lead.prenom || ''} ${lead.nom || ''}</strong></td>
                <td>${lead.email || '—'}<br><small style="color:#64748b">${lead.telephone || ''}</small></td>
                <td>${lead.ville || '—'}</td>
                <td>${presta}</td>
                <td>${statusBadge}</td>
                <td><div class="actions">${actions}</div></td>
            </tr>`;
        });

        html += '</tbody></table>';
        document.getElementById('leads-body').innerHTML = html;
    }

    function filterLeads(filter, btn) {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('filter-btn--active'));
        if (btn) btn.classList.add('filter-btn--active');
        renderLeads();
    }

    // ── Approve Modal ──
    function showApproveModal(row) {
        const lead = allLeads.find(l => l._row === row);
        const presta = prestationLabels[lead.prestation] || lead.prestation || '—';

        let optionsHtml = leadTypes.map(t =>
            `<option value="${t.id}">${t.label} — ${t.ht}€ HT / ${t.ttc}€ TTC</option>`
        ).join('');

        document.getElementById('approve-modal-content').innerHTML = `
            <h3>Valider le lead</h3>
            <div class="modal-row"><span class="modal-label">Nom</span><span class="modal-value"><strong>${lead.prenom || ''} ${lead.nom || ''}</strong></span></div>
            <div class="modal-row"><span class="modal-label">Prestation</span><span class="modal-value">${presta}</span></div>
            <div class="modal-row"><span class="modal-label">Ville</span><span class="modal-value">${lead.ville || '—'}</span></div>
            <div class="approve-form">
                <label>Type de lead (facturation client)</label>
                <select id="lead-type-select" onchange="updatePrice()">
                    ${optionsHtml}
                </select>
                <div class="approve-price" id="approve-price">
                    <div class="approve-price__row"><span>Prix HT</span><span id="price-ht">30,00 €</span></div>
                    <div class="approve-price__row"><span>TVA (20%)</span><span id="price-tva">6,00 €</span></div>
                    <div class="approve-price__row approve-price__row--total"><span>Prix TTC</span><span id="price-ttc">36,00 €</span></div>
                </div>
                <div class="approve-actions">
                    <button class="btn-cancel" onclick="closeApproveModal()">Annuler</button>
                    <button class="btn-confirm-approve" onclick="confirmApprove(${row})">Valider et envoyer</button>
                </div>
            </div>
        `;
        document.getElementById('approve-modal').classList.add('open');
    }

    function updatePrice() {
        const selected = document.getElementById('lead-type-select').value;
        const type = leadTypes.find(t => t.id === selected);
        if (type) {
            document.getElementById('price-ht').textContent = type.ht.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('price-tva').textContent = (type.ttc - type.ht).toFixed(2).replace('.', ',') + ' €';
            document.getElementById('price-ttc').textContent = type.ttc.toFixed(2).replace('.', ',') + ' €';
        }
    }

    function closeApproveModal() {
        document.getElementById('approve-modal').classList.remove('open');
    }

    async function confirmApprove(row) {
        const selected = document.getElementById('lead-type-select').value;
        const type = leadTypes.find(t => t.id === selected);
        try {
            const data = await apiCall('approve&row=' + row + '&leadType=' + encodeURIComponent(type.label) + '&priceTTC=' + type.ttc, 'POST');
            toast('Lead approuvé — ' + type.label + ' (' + type.ttc + '€ TTC)', 'success');
            closeApproveModal();
            loadLeads();
        } catch (e) {
            toast('Erreur : ' + e.message, 'error');
        }
    }

    // ── Reject ──
    async function rejectLead(row) {
        if (!confirm('Rejeter ce lead ?')) return;
        try {
            await apiCall('reject&row=' + row, 'POST');
            toast('Lead rejeté', 'success');
            loadLeads();
        } catch (e) {
            toast('Erreur : ' + e.message, 'error');
        }
    }

    // ── Detail Modal ──
    function showDetail(lead) {
        const date = lead.timestamp ? new Date(lead.timestamp).toLocaleString('fr-FR') : 'N/A';
        const presta = prestationLabels[lead.prestation] || lead.prestation || 'N/A';
        const details = (lead.details || 'Aucun détail').replace(/\n/g, '<br>');

        document.getElementById('modal-content').innerHTML = `
            <h3>Détail du lead</h3>
            <div class="modal-row"><span class="modal-label">Date</span><span class="modal-value">${date}</span></div>
            <div class="modal-row"><span class="modal-label">Formulaire</span><span class="modal-value"><span class="badge badge--${lead.form_name}">${lead.form_name}</span></span></div>
            <div class="modal-row"><span class="modal-label">Nom</span><span class="modal-value">${lead.prenom || ''} ${lead.nom || ''}</span></div>
            <div class="modal-row"><span class="modal-label">Email</span><span class="modal-value"><a href="mailto:${lead.email}">${lead.email || 'N/A'}</a></span></div>
            <div class="modal-row"><span class="modal-label">Téléphone</span><span class="modal-value"><a href="tel:${lead.telephone}">${lead.telephone || 'N/A'}</a></span></div>
            <div class="modal-row"><span class="modal-label">Ville</span><span class="modal-value">${lead.ville || 'N/A'}</span></div>
            <div class="modal-row"><span class="modal-label">Prestation</span><span class="modal-value">${presta}</span></div>
            <div class="modal-row"><span class="modal-label">Détails</span><span class="modal-value">${details}</span></div>
            <div class="modal-row"><span class="modal-label">Statut</span><span class="modal-value"><span class="badge badge--${lead.status}">${lead.status}</span></span></div>
            ${lead.lead_type ? `<div class="modal-row"><span class="modal-label">Type lead</span><span class="modal-value">${lead.lead_type}</span></div>` : ''}
            ${lead.price_ttc ? `<div class="modal-row"><span class="modal-label">Prix TTC</span><span class="modal-value">${lead.price_ttc} €</span></div>` : ''}
            ${lead.sent_to ? `<div class="modal-row"><span class="modal-label">Envoyé à</span><span class="modal-value">${lead.sent_to}</span></div>` : ''}
            <button class="modal-close" onclick="closeModal()">Fermer</button>
        `;
        document.getElementById('modal').classList.add('open');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('open');
    }

    document.getElementById('modal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    document.getElementById('approve-modal').addEventListener('click', function(e) {
        if (e.target === this) closeApproveModal();
    });

    // ── Config ──
    async function loadConfig() {
        try {
            const data = await apiCall('getConfig');
            document.getElementById('client-emails').value = (data.client_emails || []).join('\n');
        } catch (e) {
            toast('Erreur chargement config', 'error');
        }
    }

    async function saveConfig() {
        const raw = document.getElementById('client-emails').value;
        const emails = raw.split('\n').map(e => e.trim()).filter(e => e && e.includes('@'));
        try {
            await apiCall('saveConfig', 'POST', { client_emails: emails });
            toast(emails.length + ' email(s) enregistré(s)', 'success');
        } catch (e) {
            toast('Erreur sauvegarde', 'error');
        }
    }

    // ── Export CSV Microsoft Ads ──
    function exportConversionsCSV() {
        const approved = allLeads.filter(l => l.status === 'approuvé' && l.msclkid);
        if (approved.length === 0) {
            toast('Aucun lead approuvé avec msclkid à exporter', 'error');
            return;
        }

        let csv = 'Type,Status,Id,Parent Id,Client Id,Name,Conversion Currency Code,Conversion Name,Conversion Time,Conversion Value,Microsoft Click Id\n';
        csv += 'Format Version,,,,,6.0,,,,,\n';

        approved.forEach(lead => {
            const convTime = lead.sent_at ? new Date(lead.sent_at).toLocaleDateString('en-US') + ' ' + new Date(lead.sent_at).toLocaleTimeString('en-US') : new Date().toLocaleDateString('en-US') + ' ' + new Date().toLocaleTimeString('en-US');
            const value = lead.price_ttc || '0';
            const msclkid = (lead.msclkid || '').toString().trim();
            csv += `Offline Conversion,,,,,,EUR,Lead Validé,${convTime},${value},${msclkid}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'microsoft-ads-conversions-' + new Date().toISOString().slice(0, 10) + '.csv';
        a.click();
        URL.revokeObjectURL(url);

        toast(approved.length + ' conversion(s) exportée(s)', 'success');
    }

    // ── ROI Dashboard ──
    let budgets = [];
    let roiPeriod = 6;
    let roiLoaded = false;

    // Set default month to current month
    (function() {
        const now = new Date();
        const m = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        var el = document.getElementById('budget-month');
        if (el) el.value = m;
    })();

    async function loadROIData() {
        document.getElementById('roi-table-body').innerHTML = '<div class="loading">Chargement des données...</div>';
        try {
            const data = await apiCall('getBudgets');
            budgets = data.budgets || [];
            roiLoaded = true;
            renderROI();
        } catch (e) {
            document.getElementById('roi-table-body').innerHTML = '<div class="empty">Erreur de chargement.</div>';
        }
    }

    async function addBudget() {
        const month = document.getElementById('budget-month').value;
        const amount = parseFloat(document.getElementById('budget-amount').value);
        const source = document.getElementById('budget-source').value.trim() || 'Microsoft Ads';

        if (!month || !amount || amount <= 0) {
            toast('Remplissez le mois et le montant', 'error');
            return;
        }

        try {
            await apiCall('saveBudget', 'POST', { month, amount, source });
            document.getElementById('budget-amount').value = '';
            toast('Dépense ajoutée', 'success');
            roiLoaded = false;
            loadROIData();
        } catch (e) {
            toast('Erreur ajout dépense', 'error');
        }
    }

    async function deleteBudgetRow(row) {
        if (!confirm('Supprimer cette dépense ?')) return;
        try {
            await apiCall('deleteBudget&row=' + row, 'POST');
            toast('Dépense supprimée', 'success');
            roiLoaded = false;
            loadROIData();
        } catch (e) {
            toast('Erreur suppression', 'error');
        }
    }

    function setROIPeriod(months, btn) {
        roiPeriod = months;
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('period-btn--active'));
        if (btn) btn.classList.add('period-btn--active');
        renderROI();
    }

    function getMonthlyRevenue() {
        const monthlyRev = {};
        allLeads.filter(l => l.status === 'approuvé' && l.price_ttc).forEach(lead => {
            const dateStr = lead.sent_at || lead.timestamp;
            if (!dateStr) return;
            const d = new Date(dateStr);
            const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
            const ht = (parseFloat(lead.price_ttc) || 0) / 1.2;
            monthlyRev[key] = (monthlyRev[key] || { ht: 0, count: 0 });
            monthlyRev[key].ht += ht;
            monthlyRev[key].count += 1;
        });
        return monthlyRev;
    }

    function getMonthlySpend() {
        const monthlySpend = {};
        budgets.forEach(b => {
            const key = b.month; // already YYYY-MM
            monthlySpend[key] = monthlySpend[key] || { amount: 0, rows: [] };
            monthlySpend[key].amount += b.amount;
            monthlySpend[key].rows.push(b);
        });
        return monthlySpend;
    }

    function renderROI() {
        const monthlyRev = getMonthlyRevenue();
        const monthlySpend = getMonthlySpend();

        // Build combined monthly data
        const allMonths = new Set();
        Object.keys(monthlySpend).forEach(k => allMonths.add(k));
        Object.keys(monthlyRev).forEach(k => allMonths.add(k));

        let sortedMonths = Array.from(allMonths).sort().reverse();

        // Filter by period
        const now = new Date();
        const cutoff = new Date(now.getFullYear(), now.getMonth() - roiPeriod + 1, 1);
        const cutoffKey = cutoff.getFullYear() + '-' + String(cutoff.getMonth() + 1).padStart(2, '0');
        sortedMonths = sortedMonths.filter(m => m >= cutoffKey);

        // Calculate totals
        let totalSpend = 0, totalRevenue = 0, totalLeads = 0;
        const rows = sortedMonths.map(month => {
            const spend = monthlySpend[month]?.amount || 0;
            const rev = monthlyRev[month]?.ht || 0;
            const leads = monthlyRev[month]?.count || 0;
            const roi = spend > 0 ? ((rev - spend) / spend * 100) : (rev > 0 ? 100 : 0);
            const budgetRows = monthlySpend[month]?.rows || [];

            totalSpend += spend;
            totalRevenue += rev;
            totalLeads += leads;

            return { month, spend, rev, leads, roi, budgetRows };
        });

        // Find max values for bar widths
        const maxVal = Math.max(...rows.map(r => Math.max(r.spend, r.rev)), 1);

        // Render summary cards
        const totalROI = totalSpend > 0 ? ((totalRevenue - totalSpend) / totalSpend * 100) : 0;
        const totalCPL = totalLeads > 0 ? totalSpend / totalLeads : 0;

        document.getElementById('roi-total-spend').textContent = fmtEur(totalSpend);
        document.getElementById('roi-total-revenue').textContent = fmtEur(totalRevenue);
        document.getElementById('roi-total-roi').textContent = (totalROI >= 0 ? '+' : '') + totalROI.toFixed(0) + ' %';
        document.getElementById('roi-total-roi').className = 'roi-stat__number ' + (totalROI >= 0 ? 'roi-positive' : 'roi-negative');
        document.getElementById('roi-total-cpl').textContent = fmtEur(totalCPL);

        // Render table
        if (rows.length === 0) {
            document.getElementById('roi-table-body').innerHTML = '<div class="empty">Aucune donnée. Ajoutez vos dépenses pub ci-dessus.</div>';
            return;
        }

        const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];

        let html = `<table>
            <thead><tr>
                <th>Mois</th><th>Dépenses HT</th><th>Revenus HT</th><th>ROI</th><th>Leads</th><th></th>
            </tr></thead><tbody>`;

        rows.forEach(r => {
            const parts = r.month.split('-');
            const monthLabel = monthNames[parseInt(parts[1]) - 1] + ' ' + parts[0];
            const roiClass = r.roi >= 0 ? 'roi-positive' : 'roi-negative';
            const spendBarW = (r.spend / maxVal * 100).toFixed(0);
            const revBarW = (r.rev / maxVal * 100).toFixed(0);

            const deleteButtons = r.budgetRows.map(b =>
                '<button class="btn-delete-budget" onclick="deleteBudgetRow(' + b._row + ')" title="Supprimer ' + b.source + ' — ' + fmtEur(b.amount) + '">✕</button>'
            ).join('');

            html += `<tr>
                <td><strong>${monthLabel}</strong></td>
                <td><div class="roi-bar-cell"><span style="min-width:70px">${fmtEur(r.spend)}</span><div class="roi-bar roi-bar--spend" style="width:${spendBarW}%"></div></div></td>
                <td><div class="roi-bar-cell"><span style="min-width:70px">${fmtEur(r.rev)}</span><div class="roi-bar roi-bar--revenue" style="width:${revBarW}%"></div></div></td>
                <td><span class="${roiClass}">${r.roi >= 0 ? '+' : ''}${r.roi.toFixed(0)}%</span></td>
                <td>${r.leads}</td>
                <td>${deleteButtons}</td>
            </tr>`;
        });

        // Total row
        const totalROIClass = totalROI >= 0 ? 'roi-positive' : 'roi-negative';
        html += `<tr style="background:#f8fafc;font-weight:600;">
            <td>Total</td>
            <td>${fmtEur(totalSpend)}</td>
            <td>${fmtEur(totalRevenue)}</td>
            <td><span class="${totalROIClass}">${totalROI >= 0 ? '+' : ''}${totalROI.toFixed(0)}%</span></td>
            <td>${totalLeads}</td>
            <td></td>
        </tr>`;

        html += '</tbody></table>';
        document.getElementById('roi-table-body').innerHTML = html;
    }

    function fmtEur(val) {
        return val.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' €';
    }

    // ── Toast ──
    function toast(msg, type) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.className = 'toast show' + (type ? ' toast--' + type : '');
        clearTimeout(el._timeout);
        el._timeout = setTimeout(() => { el.className = 'toast'; }, 4000);
    }

    // ── Init ──
    init();
    </script>
</body>
</html>
